---
# - name: deploy enabled topics
#   file:
#     state: link
#     path: "{{ $DOTFILES + item }}"
- debug:
    var: topics
    verbosity: 1

- set_fact:
    enabled_topics: "{{ q('dict', topics) | map(attribute='value') | list | flatten | selectattr('state', 'equalto', 'present') | list }}"

- debug:
    var: enabled_topics
    verbosity: 1

- set_fact:
    brew_formulas: "{{ enabled_topics | map(attribute='brew_formulas') | list | flatten | unique }}"

- debug:
    var: brew_formulas
    verbosity: 1

- set_fact:
    topic_links: "{{ enabled_topics | selectattr('links', 'defined') | map(attribute='links') | list | flatten | unique }}"

- set_fact:
    topics_with_links: "{{ enabled_topics | selectattr('links', 'defined') | list }}"
- debug:
    var: topics_with_links

# - debug:
#     msg: "{{ enabled_topics | selectattr('links', 'defined') | map('combine', {'baz':3}) | list }}"
# - set_fact:
#     detailed_links: " {{ (detailed_links|default({})) | combine(item.) }}"
#   loop: "{{ enabled_topics | dict2items }}"

- include_tasks: link-stuff.yml
  loop: "{{ enabled_topics | selectattr('links', 'defined') | list }}"
  loop_control:
    loop_var: topic

# - name: link stuff
#   file:
#     path: "{{ item.src }}"
#     dest: "{{ item.dest | regex_replace('/$', '/' + item.src) }}"
#     state: link
#   loop: "{{ all_links }}"

- debug:
    var: topic_links
    verbosity: 1
